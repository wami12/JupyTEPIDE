# Copyright (c) Jupyter Development Team.
# Distributed under the terms of the Modified BSD License.

# Pin to version of notebook image that includes start-singleuser.sh script
ARG DOCKER_NOTEBOOK_IMAGE
FROM $DOCKER_NOTEBOOK_IMAGE

# Use custom startup script
USER root

# ------------ PLACE FOR TESTING -----------------
# Install JupyTEP IDE UI layout and enable it
#RUN cd /tmp && \
#    git clone https://github.com/wasat/JupyTEPIDE.git && \
#    cp -rf /tmp/JupyTEPIDE/GUI/jupyter_resources/static/* "/opt/conda/lib/python3.6/site-packages/notebook/static" && \
#    cd JupyTEPIDE && \
#    cp -R notebooks /home/jovyan/ && \
#    cd GUI && \
#    jupyter nbextension install source_UI --user && \
#    jupyter nbextension enable source_UI/main --sys-prefix && \
#    mkdir -p /home/jovyan/.ipython/profile_default/startup && \
#    cp /tmp/JupyTEPIDE/scripts/startup/01-otb-paths.py /home/jovyan/.ipython/profile_default/startup/01-otb-paths.py && \
#    cp /tmp/JupyTEPIDE/scripts/startup/02-init-leaflet.py /home/jovyan/.ipython/profile_default/startup/02-init-leaflet.py && \
#    cp /tmp/JupyTEPIDE/scripts/startup/03-import_notebook_as_module.py /home/jovyan/.ipython/profile_default/startup/03-import_notebook_as_module.py && \
#    cp /tmp/JupyTEPIDE/scripts/startup/04-mapnik.py /home/jovyan/.ipython/profile_default/startup/04-mapnik.py && \
#    cp /tmp/JupyTEPIDE/scripts/startup/05-grass.py /home/jovyan/.ipython/profile_default/startup/05-grass.py && \
#    cp -R /tmp/JupyTEPIDE /opt/ && \
#    find /tmp -mindepth 1 -maxdepth 1 -print0 | xargs -0 rm -rf && \
#    fix-permissions $CONDA_DIR && \
#    fix-permissions /home/$NB_USER
# ------------ END TESTING -----------------------

# Install JupyTEP IDE UI layout and enable it
RUN mkdir /home/$NB_USER/dev && \
    cd /home/$NB_USER/dev && \
    git clone -b dev --single-branch https://github.com/wasat/JupyTEPIDE.git && \
    rm -rf /home/jovyan/work/notebook_count/ && \
    fix-permissions /home/$NB_USER

COPY spawn/docker-entrypoint.sh /srv/docker-entrypoint.sh
RUN chmod 777 /srv/docker-entrypoint.sh
ENTRYPOINT ["tini", "--", "/srv/docker-entrypoint.sh"]
CMD ["start-singleuser.sh"]

WORKDIR /home/$NB_USER
USER $NB_USER
